<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai Siswa - MTsN 6 Demak</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #fdf2f8 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }

        /* Error Box Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .shake-error { animation: shake 0.5s ease-in-out; }
    </style>
</head>
<body class="text-slate-700 pb-10">

    <!-- Navbar -->
    <div class="max-w-7xl mx-auto pt-6 px-4">
        <nav class="glass rounded-2xl shadow-sm px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 z-50 sticky top-4">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-500 p-3 rounded-xl shadow-lg text-white transform hover:rotate-6 transition duration-300">
                    <i data-lucide="graduation-cap" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Portal Nilai</h1>
                    <p class="text-xs font-semibold text-slate-400 tracking-wider uppercase">MTsN 6 Demak Database</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadCSV()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition transform hover:scale-105 shadow-md shadow-emerald-200">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 fade-in">
        
        <!-- Connection Status (DIAGNOSTIC BOX) -->
        <div id="connection-status" class="mb-6 mx-auto w-full max-w-2xl text-center">
            <div class="inline-flex items-center gap-3 bg-white/80 backdrop-blur px-6 py-3 rounded-full border border-slate-200 shadow-sm text-slate-500 font-semibold text-sm">
                <div class="animate-spin w-4 h-4 border-2 border-slate-300 border-t-blue-500 rounded-full"></div>
                Sedang menghubungkan ke server...
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5">
                <div class="bg-indigo-100 p-4 rounded-2xl text-indigo-600">
                    <i data-lucide="users" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Siswa</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="total-students">0</h3>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5">
                <div class="bg-orange-100 p-4 rounded-2xl text-orange-600">
                    <i data-lucide="star" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Rata-rata</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="avg-score">0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5">
                <div class="bg-teal-100 p-4 rounded-2xl text-teal-600">
                    <i data-lucide="activity" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Live</p>
                    <h3 class="text-lg font-bold text-slate-400 flex items-center gap-2" id="sync-status">
                        Offline
                    </h3>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-3">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg">
                        <i data-lucide="list-checks" class="w-5 h-5"></i>
                    </span>
                    Data Nilai
                </h2>
                <div class="relative w-full md:w-72">
                    <input type="text" id="searchInput" onkeyup="window.filterTable()" placeholder="Cari..." class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-100 text-sm">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-4 top-3.5"></i>
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b border-slate-100">
                            <th class="p-5 w-16 text-center">No</th>
                            <th class="p-5 cursor-pointer hover:bg-slate-100" onclick="window.sortTable('timestamp')">Waktu ↕</th>
                            <th class="p-5 cursor-pointer hover:bg-slate-100" onclick="window.sortTable('name')">Nama Siswa ↕</th>
                            <th class="p-5 cursor-pointer hover:bg-slate-100" onclick="window.sortTable('kelas')">Kelas ↕</th>
                            <th class="p-5">Materi</th>
                            <th class="p-5 text-center cursor-pointer hover:bg-slate-100" onclick="window.sortTable('score')">Nilai ↕</th>
                            <th class="p-5 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="score-table-body" class="text-sm font-medium text-slate-600 divide-y divide-slate-50">
                        <tr>
                            <td colspan="7" class="p-10 text-center text-slate-400 italic">
                                Memuat data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50/80 text-xs text-slate-400 text-center border-t border-slate-100">
                System v3.0 (Diagnostic Mode) • Jika merah berarti error
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkX8qAS-O_5m_qaGr8Aa9XME-lVyBMibw",
            authDomain: "belajaronline-b5512.firebaseapp.com",
            projectId: "belajaronline-b5512",
            storageBucket: "belajaronline-b5512.firebasestorage.app",
            messagingSenderId: "896107581081",
            appId: "1:896107581081:web:629056c097c90fdf583208",
            measurementId: "G-7MKNGF9PCX"
        };

        // Init App with Error Catching
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            showError("Gagal Inisialisasi Firebase", e.message);
        }

        const appId = 'belajaronline-b5512';
        const COLLECTION_NAME = 'scores';
        
        let globalData = [];
        let currentSort = { column: 'timestamp', direction: 'desc' };

        // --- IMPROVED ERROR DISPLAY ---
        function showError(title, detail) {
            const statusEl = document.getElementById('connection-status');
            statusEl.innerHTML = `
                <div class="shake-error inline-block text-left bg-red-50 border border-red-200 rounded-xl p-4 max-w-lg shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="text-red-500 bg-red-100 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-red-700 text-sm mb-1">${title}</h3>
                            <p class="text-xs text-red-600 font-mono bg-white/50 p-2 rounded border border-red-100 break-all">
                                ${detail}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- AUTH & DIAGNOSTICS ---
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                
                let friendlyTitle = "Koneksi Ditolak";
                let friendlyMsg = error.message;

                if (error.code === 'auth/unauthorized-domain') {
                    friendlyTitle = "Domain Belum Terdaftar";
                    friendlyMsg = `ALAMAT WEB INI DIBLOKIR FIREBASE.<br><br>Solusi: Buka Firebase Console > Authentication > Settings > Authorized Domains > Tambahkan domain hosting Anda (misal: github.io).`;
                } else if (error.code === 'auth/operation-not-allowed') {
                    friendlyTitle = "Fitur Login Belum Aktif";
                    friendlyMsg = `Solusi: Buka Firebase Console > Authentication > Sign-in method > Aktifkan "Anonymous".`;
                }

                showError(friendlyTitle, friendlyMsg);
            }
        };

        // Jalankan Auth
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Success State
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = `
                    <div class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-600 px-5 py-2 rounded-full border border-emerald-100 text-sm font-bold shadow-sm">
                        <span class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                        </span>
                        Live Database Terhubung
                    </div>
                `;
                
                document.getElementById('sync-status').innerHTML = '<span class="text-emerald-500 font-bold">● Online</span>';
                
                subscribeToData();
                checkIncomingDataAndSave();
            }
        });

        // --- HELPERS (Same as before) ---
        function normalizeClass(kelasInput) {
            if (!kelasInput) return '-';
            let str = kelasInput.toString().toUpperCase();
            if (str.includes('8') || str.includes('VIII')) return '8' + (str.replace(/[^A-Z]/g, '').slice(-1) || '');
            if (str.includes('9') || str.includes('IX')) return '9' + (str.replace(/[^A-Z]/g, '').slice(-1) || '');
            if (str.includes('7') || str.includes('VII')) return '7' + (str.replace(/[^A-Z]/g, '').slice(-1) || '');
            return str.replace(/[^A-Z0-9]/g, '').slice(0, 3);
        }

        function splitNames(nameStr) {
            if (!nameStr) return [];
            return nameStr.split(/\s*&\s*|\s*,\s*|\s*\+\s*|\s+DAN\s+|\s+AND\s+/i)
                          .map(n => n.trim()).filter(n => n.length > 2);
        }

        // --- SAVE DATA ---
        async function checkIncomingDataAndSave() {
            const params = new URLSearchParams(window.location.search);
            if (!params.get('name') || !params.get('score')) return;

            const sessionKey = `saved_v7_${params.get('name')}_${params.get('score')}`;
            if (sessionStorage.getItem(sessionKey)) return;

            try {
                Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                
                const names = splitNames(params.get('name').toUpperCase());
                const commonData = {
                    kelas: normalizeClass(params.get('kelas')),
                    score: parseInt(params.get('score')),
                    materi: params.get('materi') || params.get('mapel') || '-',
                    date: params.get('date') || new Date().toLocaleDateString('id-ID'),
                    timestamp: Date.now()
                };

                await Promise.all(names.map(name => 
                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), { ...commonData, name })
                ));

                sessionStorage.setItem(sessionKey, 'true');
                Swal.fire('Berhasil', `${names.length} Data Tersimpan`, 'success');
                window.history.replaceState({}, '', window.location.pathname);
            } catch (e) {
                showError("Gagal Menyimpan Data", e.message);
                Swal.close();
            }
        }

        // --- REALTIME DATA ---
        function subscribeToData() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), 
                (snapshot) => {
                    let raw = [];
                    snapshot.forEach(doc => raw.push({ id: doc.id, ...doc.data() }));
                    
                    // Simple Aggregation: Ambil nilai terbaru per siswa per materi
                    const map = {};
                    raw.forEach(d => {
                        const key = d.name.toUpperCase() + '_' + d.materi;
                        if (!map[key] || d.timestamp > map[key].timestamp) map[key] = d;
                    });
                    
                    globalData = Object.values(map);
                    window.filterTable();
                    
                    // Stats
                    document.getElementById('total-students').innerText = globalData.length;
                    const avg = globalData.length ? (globalData.reduce((a,b)=>a+(parseInt(b.score)||0),0)/globalData.length).toFixed(1) : 0;
                    document.getElementById('avg-score').innerText = avg;
                },
                (err) => showError("Terputus dari Database", err.code === 'permission-denied' ? "Cek Firestore Rules Anda." : err.message)
            );
        }

        // --- UI FUNCTIONS ---
        window.filterTable = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = globalData.filter(i => 
                (i.name||'').toLowerCase().includes(term) || 
                (i.kelas||'').toLowerCase().includes(term)
            ).sort((a,b) => {
                const va = a[currentSort.column], vb = b[currentSort.column];
                return currentSort.direction === 'asc' ? (va>vb?1:-1) : (va<vb?1:-1);
            });
            renderTable(filtered);
        };

        window.sortTable = (col) => {
            if(currentSort.column === col) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            else { currentSort.column = col; currentSort.direction = 'desc'; }
            window.filterTable();
        };

        function renderTable(data) {
            const tbody = document.getElementById('score-table-body');
            if(!data.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-10 text-center text-slate-400">Data tidak ditemukan</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map((d,i) => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="p-4 text-center text-slate-400 font-mono text-xs">${i+1}</td>
                    <td class="p-4 text-xs text-slate-500">${new Date(d.timestamp).toLocaleTimeString()}</td>
                    <td class="p-4 font-bold text-slate-700 capitalize">${(d.name||'').toLowerCase()}</td>
                    <td class="p-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">${d.kelas}</span></td>
                    <td class="p-4 text-sm text-slate-600 truncate max-w-[150px]">${d.materi}</td>
                    <td class="p-4 text-center font-bold ${d.score>=75?'text-emerald-500':'text-orange-500'}">${d.score}</td>
                    <td class="p-4 text-center">
                        <span class="text-[10px] font-bold px-2 py-1 rounded border ${d.score>=75?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-orange-50 text-orange-600 border-orange-100'}">
                            ${d.score>=75?'TUNTAS':'REMIDI'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        window.downloadCSV = () => {
            const csv = "Waktu,Nama,Kelas,Materi,Nilai\n" + globalData.map(d => 
                `${new Date(d.timestamp).toLocaleString()},"${d.name}","${d.kelas}","${d.materi}",${d.score}`
            ).join("\n");
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            a.download = 'Rekap_Nilai.csv';
            a.click();
        };

        lucide.createIcons();
    </script>
</body>
</html>


