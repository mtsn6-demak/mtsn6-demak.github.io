<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai Siswa - MTsN 6 Demak</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            background: linear-gradient(135deg, #eef2ff 0%, #fdf2f8 100%);
            min-height: 100vh;
        }
        
        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar for Table */
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body class="text-slate-700 pb-10">

    <div class="max-w-7xl mx-auto pt-6 px-4">
        <nav class="glass rounded-2xl shadow-sm px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 z-50 sticky top-4">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-500 p-3 rounded-xl shadow-lg text-white transform hover:rotate-6 transition duration-300">
                    <i data-lucide="graduation-cap" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Portal Nilai</h1>
                    <p class="text-xs font-semibold text-slate-400 tracking-wider uppercase">MTsN 6 Demak Database</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadCSV()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition transform hover:scale-105 shadow-md shadow-emerald-200">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Unduh Excel
                </button>
                <button onclick="clearData()" class="flex items-center gap-2 bg-rose-500 hover:bg-rose-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition transform hover:scale-105 shadow-md shadow-rose-200">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Reset Data
                </button>
            </div>
        </nav>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-8 fade-in">
        
        <div id="connection-status" class="mb-6 text-sm font-semibold text-center text-slate-400 flex justify-center items-center gap-2 bg-white/50 py-2 rounded-full w-fit mx-auto px-6 border border-white">
            <div class="animate-spin w-4 h-4 border-2 border-slate-300 border-t-blue-500 rounded-full"></div> 
            Menghubungkan...
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-indigo-100 p-4 rounded-2xl text-indigo-600">
                    <i data-lucide="users" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Siswa</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="total-students">0</h3>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-orange-100 p-4 rounded-2xl text-orange-600">
                    <i data-lucide="star" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Rata-rata Kelas</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="avg-score">0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-teal-100 p-4 rounded-2xl text-teal-600">
                    <i data-lucide="activity" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Live</p>
                    <h3 class="text-lg font-bold text-teal-600 flex items-center gap-2" id="sync-status">
                        Offline
                    </h3>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-3">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg">
                        <i data-lucide="list-checks" class="w-5 h-5"></i>
                    </span>
                    Daftar Nilai Masuk
                </h2>
                <div class="relative w-full md:w-72">
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari Nama Siswa..." class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition font-semibold text-sm">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-4 top-3.5"></i>
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b border-slate-100">
                            <th class="p-5 text-center w-16">No</th>
                            <th class="p-5">Waktu</th>
                            <th class="p-5">Nama Siswa</th>
                            <th class="p-5">Kelas</th>
                            <th class="p-5 text-center">Nilai</th>
                            <th class="p-5 text-center">Status</th>
                            <th class="p-5 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="score-table-body" class="text-sm font-medium text-slate-600 divide-y divide-slate-50">
                        <tr>
                            <td colspan="7" class="p-10 text-center text-slate-400 italic">
                                <div class="flex flex-col items-center justify-center gap-3">
                                    <div class="animate-bounce text-3xl">ðŸ“‚</div>
                                    <span>Sedang memuat data...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50/80 text-xs font-semibold text-slate-400 text-center border-t border-slate-100">
                MTsN 6 Demak â€¢ Sistem Penilaian Digital v2.0
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkX8qAS-O_5m_qaGr8Aa9XME-lVyBMibw",
            authDomain: "belajaronline-b5512.firebaseapp.com",
            projectId: "belajaronline-b5512",
            storageBucket: "belajaronline-b5512.firebasestorage.app",
            messagingSenderId: "896107581081",
            appId: "1:896107581081:web:629056c097c90fdf583208",
            measurementId: "G-7MKNGF9PCX"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'belajaronline-b5512';
        const COLLECTION_NAME = 'scores';
        
        let globalData = [];

        // --- AUTH & KONEKSI ---
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Koneksi Gagal',
                    text: 'Gagal masuk ke database. Cek konfigurasi Firebase.',
                    confirmButtonColor: '#ef4444'
                });
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = '<span class="text-emerald-500 font-bold flex items-center gap-2">âœ“ Terhubung</span>';
                statusEl.classList.add('bg-emerald-50', 'border-emerald-100');
                
                document.getElementById('sync-status').innerHTML = '<span class="flex items-center gap-2"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-teal-500"></span></span> Live Sync</span>';

                subscribeToData();
                checkIncomingDataAndSave();
            }
        });

        // --- LOGIKA SIMPAN DATA ---
        async function checkIncomingDataAndSave() {
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name');
            const score = params.get('score');
            const kelas = params.get('kelas');
            
            // Key Unik Session
            const sessionKey = `saved_v2_${name}_${score}_${params.get('date')}`;

            if (name && score && !sessionStorage.getItem(sessionKey)) {
                try {
                    // Tampilkan Loading Swal
                    Swal.fire({
                        title: 'Menyimpan Data...',
                        text: 'Mohon tunggu sebentar',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading() }
                    });

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                        name: name,
                        kelas: kelas || '-',
                        score: parseInt(score),
                        type: params.get('type') || 'Kuis',
                        date: params.get('date') || new Date().toLocaleDateString('id-ID'),
                        timestamp: Date.now()
                    });

                    sessionStorage.setItem(sessionKey, 'true');
                    
                    // Sukses Swal
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: `Nilai atas nama ${name} telah tersimpan.`,
                        timer: 3000,
                        showConfirmButton: false
                    });

                    window.history.replaceState({}, document.title, window.location.pathname);

                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Menyimpan',
                        text: e.message
                    });
                }
            }
        }

        // --- BACA DATA (LISTENER) ---
        function subscribeToData() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
            
            onSnapshot(q, (querySnapshot) => {
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                
                data.sort((a, b) => b.timestamp - a.timestamp);
                globalData = data;
                renderTable(data);
                updateStats(data);
            });
        }

        // --- RENDER UI ---
        function renderTable(data) {
            const tbody = document.getElementById('score-table-body');
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-10 text-center text-slate-400 italic">Belum ada data nilai masuk hari ini.</td></tr>`;
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                // Logic Warna & Status
                const isPass = item.score >= 75; // KKM Contoh
                const badgeColor = isPass ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-rose-100 text-rose-700 border-rose-200';
                const statusIcon = isPass ? 'CheckCircle' : 'XCircle';
                const statusText = isPass ? 'Tuntas' : 'Remidi';
                const dateDisplay = item.timestamp ? new Date(item.timestamp).toLocaleString('id-ID', { hour:'2-digit', minute:'2-digit', day:'numeric', month:'short' }) : item.date;

                html += `
                    <tr class="hover:bg-blue-50/50 transition duration-200 group">
                        <td class="p-5 text-center font-bold text-slate-400">${data.length - index}</td>
                        <td class="p-5 text-xs text-slate-500 font-mono">${dateDisplay}</td>
                        <td class="p-5 font-bold text-slate-700 text-base">${item.name}</td>
                        <td class="p-5"><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold border border-indigo-200">${item.kelas}</span></td>
                        <td class="p-5 text-center">
                            <span class="text-lg font-extrabold ${item.score >= 80 ? 'text-blue-600' : 'text-slate-600'}">${item.score}</span>
                        </td>
                        <td class="p-5 text-center">
                            <span class="${badgeColor} px-3 py-1 rounded-full text-xs font-bold border flex items-center justify-center gap-1 w-fit mx-auto">
                                ${statusText}
                            </span>
                        </td>
                        <td class="p-5 text-center">
                            <button onclick="window.deleteItem('${item.id}')" class="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-rose-500 hover:border-rose-200 hover:bg-rose-50 transition shadow-sm" title="Hapus">
                                <i data-lucide="trash" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            lucide.createIcons();
        }

        function updateStats(data) {
            // Animasi Counter sederhana
            document.getElementById('total-students').textContent = data.length;
            if (data.length > 0) {
                const totalScore = data.reduce((acc, curr) => acc + curr.score, 0);
                const avg = (totalScore / data.length).toFixed(1);
                document.getElementById('avg-score').textContent = avg;
            } else {
                document.getElementById('avg-score').textContent = "0";
            }
        }

        // --- ACTION HANDLERS (POPUP BARU) ---
        
        // 1. Hapus Item (Dengan SweetAlert)
        window.deleteItem = async (docId) => {
            // Langkah 1: Minta PIN
            const { value: pin } = await Swal.fire({
                title: 'Verifikasi Guru',
                text: 'Masukkan PIN untuk menghapus data ini',
                input: 'password',
                inputPlaceholder: 'PIN Guru',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3b82f6',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Verifikasi'
            });

            if (pin === "443588") {
                // Langkah 2: Konfirmasi Hapus
                Swal.fire({
                    title: 'Yakin hapus?',
                    text: "Data yang dihapus tidak bisa dikembalikan!",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#e11d48', // Merah Rose
                    cancelButtonColor: '#64748b',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, docId));
                            Swal.fire('Terhapus!', 'Data siswa telah dihapus.', 'success');
                        } catch(e) {
                            Swal.fire('Error', e.message, 'error');
                        }
                    }
                });
            } else if (pin) {
                Swal.fire('Akses Ditolak', 'PIN yang Anda masukkan salah.', 'error');
            }
        };

        // 2. Reset Semua Data (Dengan SweetAlert)
        window.clearData = async () => {
            const { value: pin } = await Swal.fire({
                title: 'RESET DATABASE',
                text: 'Masukkan PIN Admin untuk menghapus SEMUA data.',
                input: 'password',
                icon: 'error', // Ikon merah
                showCancelButton: true,
                confirmButtonColor: '#e11d48',
                confirmButtonText: 'Proses Reset'
            });

            if (pin === "443588") {
                Swal.fire({
                    title: 'PERINGATAN KERAS!',
                    html: "Anda akan menghapus <b>SELURUH DATA NILAI</b>.<br>Tindakan ini permanen.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e11d48',
                    confirmButtonText: 'Ya, Kosongkan Database',
                    cancelButtonText: 'Jangan!'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({title: 'Sedang menghapus...', didOpen: () => Swal.showLoading()});
                        try {
                            const q = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                            const snapshot = await getDocs(q);
                            // Batch delete manual (karena client SDK)
                            const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                            await Promise.all(deletePromises);
                            
                            Swal.fire('Selesai', 'Database telah dikosongkan.', 'success');
                        } catch(e) {
                            Swal.fire('Gagal', e.message, 'error');
                        }
                    }
                });
            } else if (pin) {
                Swal.fire('Salah PIN', 'Anda tidak memiliki akses admin.', 'error');
            }
        };

        // Filter Table
        window.filterTable = () => {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const filteredData = globalData.filter(item => 
                item.name.toLowerCase().includes(filter) || 
                (item.kelas && item.kelas.toLowerCase().includes(filter))
            );
            renderTable(filteredData);
        };

        // Download CSV
        window.downloadCSV = () => {
            if (globalData.length === 0) {
                Swal.fire('Oops...', 'Tidak ada data untuk diunduh.', 'info');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,No,Waktu,Nama Siswa,Kelas,Nilai,Status\n";
            globalData.forEach((item, index) => {
                const status = item.score >= 75 ? 'Tuntas' : 'Remidi';
                const time = item.timestamp ? new Date(item.timestamp).toLocaleString('id-ID') : item.date;
                csvContent += `${index + 1},"${time}","${item.name}",${item.kelas},${item.score},${status}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Rekap_Nilai_MTsN6.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        lucide.createIcons();
    </script>
</body>
</html>
