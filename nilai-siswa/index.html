<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai Siswa - MTsN 6 Demak</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #fdf2f8 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        th.sortable {
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }
        th.sortable:hover {
            background-color: #eff6ff;
            color: #2563eb;
        }
    </style>
</head>
<body class="text-slate-700 pb-10">

    <!-- Navbar -->
    <div class="max-w-7xl mx-auto pt-6 px-4">
        <nav class="glass rounded-2xl shadow-sm px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 z-50 sticky top-4">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-500 p-3 rounded-xl shadow-lg text-white transform hover:rotate-6 transition duration-300">
                    <i data-lucide="graduation-cap" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Portal Nilai</h1>
                    <p class="text-xs font-semibold text-slate-400 tracking-wider uppercase">MTsN 6 Demak Database</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadCSV()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition transform hover:scale-105 shadow-md shadow-emerald-200">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Unduh Excel
                </button>
                <button onclick="clearData()" class="flex items-center gap-2 bg-rose-500 hover:bg-rose-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition transform hover:scale-105 shadow-md shadow-rose-200">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Reset Data
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 fade-in">
        
        <!-- Connection Status -->
        <div id="connection-status" class="mb-6 text-sm font-semibold text-center text-slate-400 flex justify-center items-center gap-2 bg-white/50 py-2 rounded-full w-fit mx-auto px-6 border border-white">
            <div class="animate-spin w-4 h-4 border-2 border-slate-300 border-t-blue-500 rounded-full"></div>
             Menghubungkan...
        </div>

        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-indigo-100 p-4 rounded-2xl text-indigo-600">
                    <i data-lucide="users" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Siswa</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="total-students">0</h3>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-orange-100 p-4 rounded-2xl text-orange-600">
                    <i data-lucide="star" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Rata-rata Kelas</p>
                    <h3 class="text-3xl font-extrabold text-slate-800" id="avg-score">0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 flex items-center gap-5 hover:-translate-y-1 transition duration-300">
                <div class="bg-teal-100 p-4 rounded-2xl text-teal-600">
                    <i data-lucide="activity" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Live</p>
                    <h3 class="text-lg font-bold text-teal-600 flex items-center gap-2" id="sync-status">
                        Offline
                    </h3>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-3">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg">
                        <i data-lucide="list-checks" class="w-5 h-5"></i>
                    </span>
                    Daftar Nilai Masuk
                </h2>
                <div class="flex gap-4 w-full md:w-auto">
                    <div class="relative w-full md:w-72">
                        <input type="text" id="searchInput" onkeyup="window.filterTable()" placeholder="Cari Nama atau Kelas..." class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition font-semibold text-sm">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-4 top-3.5"></i>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b border-slate-100">
                            <th class="p-5 text-center w-16">No</th>
                            <th class="p-5 sortable group" onclick="window.sortTable('timestamp')">
                                <div class="flex items-center gap-1">
                                    Waktu 
                                    <i id="icon-timestamp" data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-blue-500"></i>
                                </div>
                            </th>
                            <th class="p-5 sortable group" onclick="window.sortTable('name')">
                                <div class="flex items-center gap-1">
                                    Nama Siswa 
                                    <i id="icon-name" data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-blue-500"></i>
                                </div>
                            </th>
                            <th class="p-5 sortable group" onclick="window.sortTable('kelas')">
                                <div class="flex items-center gap-1">
                                    Kelas 
                                    <i id="icon-kelas" data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-blue-500"></i>
                                </div>
                            </th>
                            <th class="p-5">Materi</th>
                            <th class="p-5 text-center sortable group" onclick="window.sortTable('score')">
                                <div class="flex items-center justify-center gap-1">
                                    Nilai 
                                    <i id="icon-score" data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-blue-500"></i>
                                </div>
                            </th>
                            <th class="p-5 text-center">Status</th>
                            <th class="p-5 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="score-table-body" class="text-sm font-medium text-slate-600 divide-y divide-slate-50">
                        <tr>
                            <td colspan="8" class="p-10 text-center text-slate-400 italic">
                                <div class="flex flex-col items-center justify-center gap-3">
                                    <div class="animate-bounce text-3xl">ðŸ“‚</div>
                                    <span>Sedang memuat data...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50/80 text-xs font-semibold text-slate-400 text-center border-t border-slate-100">
                MTsN 6 Demak â€¢ Sistem Penilaian Digital v2.6 (Auto-Materi)
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkX8qAS-O_5m_qaGr8Aa9XME-lVyBMibw",
            authDomain: "belajaronline-b5512.firebaseapp.com",
            projectId: "belajaronline-b5512",
            storageBucket: "belajaronline-b5512.firebasestorage.app",
            messagingSenderId: "896107581081",
            appId: "1:896107581081:web:629056c097c90fdf583208",
            measurementId: "G-7MKNGF9PCX"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'belajaronline-b5512';
        const COLLECTION_NAME = 'scores';
        
        let globalData = [];
        let currentSort = { column: 'timestamp', direction: 'desc' };

        // --- HELPERS ---
        function normalizeClass(kelasInput) {
            if (!kelasInput) return '-';
            let str = kelasInput.toString().toUpperCase();
            let grade = '';
            if (str.includes('8') || str.includes('VIII')) grade = '8';
            else if (str.includes('9') || str.includes('IX')) grade = '9';
            else if (str.includes('7') || str.includes('VII')) grade = '7';
            
            if (!grade) return str.replace(/\s+/g, '');

            let cleanStr = str
                .replace(/KELAS|KLS|MTS|SMP/g, '')
                .replace(/VIII|VII|IX|IV|V|VI/g, '')
                .replace(/[0-9]/g, '')
                .replace(/[^A-Z]/g, ''); 
            
            let suffix = cleanStr.charAt(0);
            return grade + (suffix || '');
        }

        function normalizeMateri(materiInput) {
            if (!materiInput) return '-';
            const text = materiInput.toString().trim();
            if (text === "" || text === "null" || text === "undefined") return '-';
            
            const lower = text.toLowerCase();
            if (lower.includes('shalat jumat')) return 'Shalat Jumat';
            if (lower.includes('khutbah jumat')) return 'Khutbah Jumat';
            if (lower.includes('optik')) return 'Cahaya dan Alat Optik';
            if (lower.includes('listrik')) return 'Listrik Dinamis';
            if (lower.includes('shalat jumat')) || if (lower.includes('khutbah jumat')) return 'Formatif : Shalat Jumat';
            if (lower.includes('tata surya')) return 'Sistem Tata Surya';
            if (lower.includes('sel')) return 'Sel Hewan & Tumbuhan';
            return text;
        }

        function splitNames(nameStr) {
            if (!nameStr) return [];
            return nameStr.split(/\s*&\s*|\s*,\s*|\s*\+\s*|\s+DAN\s+|\s+AND\s+|\s*\/\s*/i)
                          .map(n => n.trim())
                          .filter(n => n.length > 2);
        }

        // --- AUTH ---
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = '<span class="text-emerald-500 font-bold flex items-center gap-2">âœ“ Terhubung</span>';
                statusEl.classList.add('bg-emerald-50', 'border-emerald-100');
                
                document.getElementById('sync-status').innerHTML = '<span class="flex items-center gap-2"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-teal-500"></span></span> Live Sync</span>';

                subscribeToData();
                checkIncomingDataAndSave();
            }
        });

        // --- SAVE DATA ---
        async function checkIncomingDataAndSave() {
            const params = new URLSearchParams(window.location.search);
            const rawName = params.get('name');
            const score = params.get('score');
            
            if (!rawName || !score) return;

            const sessionKey = `saved_v6_${rawName}_${score}_${params.get('date') || 'today'}`;

            if (!sessionStorage.getItem(sessionKey)) {
                try {
                    Swal.fire({ title: 'Menyimpan...', didOpen: () => { Swal.showLoading() }, allowOutsideClick: false });

                    const namesList = splitNames(rawName.toUpperCase());
                    const kelas = normalizeClass(params.get('kelas'));
                    // Cek parameter materi atau mapel dari URL
                    const materi = params.get('materi') || params.get('mapel') || params.get('type') || '-';
                    const date = params.get('date') || new Date().toLocaleDateString('id-ID');
                    const timestamp = Date.now();

                    const promises = namesList.map(studentName => {
                        return addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                            name: studentName,
                            kelas: kelas,
                            score: parseInt(score),
                            materi: materi,
                            date: date,
                            timestamp: timestamp
                        });
                    });

                    await Promise.all(promises);
                    sessionStorage.setItem(sessionKey, 'true');

                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: `Data untuk ${namesList.length} siswa telah disimpan.`,
                        timer: 3000,
                        showConfirmButton: false
                    });

                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    Swal.fire({ icon: 'error', title: 'Gagal Simpan', text: e.message });
                }
            }
        }

        // --- AGGREGATION LOGIC ---
        function processAndAggregateData(rawData) {
            const studentMap = {};

            rawData.forEach(item => {
                const nameStr = item.name ? item.name.toUpperCase().trim() : 'TANPA NAMA';
                const cleanClass = normalizeClass(item.kelas);
                
                // Cari materi di berbagai field yang mungkin (materi, mapel, type)
                const rawMateri = item.materi || item.mapel || item.type || '-';
                const cleanMateri = normalizeMateri(rawMateri);
                
                const uniqueKey = `${nameStr}|${cleanClass}`;

                if (!studentMap[uniqueKey]) {
                    studentMap[uniqueKey] = {
                        ...item,
                        name: nameStr,
                        kelas: cleanClass,
                        materi: cleanMateri,
                        totalScore: parseInt(item.score) || 0,
                        count: 1,
                        originalId: item.id,
                        latestTimestamp: item.timestamp || 0
                    };
                } else {
                    const entry = studentMap[uniqueKey];
                    entry.totalScore += (parseInt(item.score) || 0);
                    entry.count += 1;

                    // Update informasi tampilan dengan data terbaru berdasarkan timestamp
                    if ((item.timestamp || 0) >= entry.latestTimestamp) {
                        entry.latestTimestamp = item.timestamp;
                        entry.originalId = item.id;
                        // Hanya update materi jika data terbaru punya materi yang valid
                        if (cleanMateri !== '-') {
                            entry.materi = cleanMateri;
                        }
                        entry.date = item.date;
                        entry.timestamp = item.timestamp;
                    }
                }
            });

            return Object.values(studentMap).map(s => {
                s.score = Math.round(s.totalScore / s.count);
                s.id = s.originalId; 
                return s;
            });
        }

        // --- DATA SUBSCRIBER ---
        function subscribeToData() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
            
            onSnapshot(q, (snapshot) => {
                const rawData = [];
                snapshot.forEach((doc) => {
                    rawData.push({ id: doc.id, ...doc.data() });
                });

                const processed = processAndAggregateData(rawData);
                globalData = processed;
                window.filterTable(); 
                updateStats(processed);
            }, (err) => {
                console.error("Snapshot error:", err);
            });
        }

        // --- UI RENDERING ---
        function renderTable(data) {
            const tbody = document.getElementById('score-table-body');
            
        